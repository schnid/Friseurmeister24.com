import React from "react";
import { motion } from "framer-motion";
import { Calendar, Clock, ShieldCheck, ChevronRight, Phone, Mail, Info, MapPin, Scissors, Settings, Check, X, Edit, Search, Filter, UserCheck, UserX, Trash2, Plus } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

// ✅ Salon-Terminseite (Deutsch)
// Hinweise:
// - Ersetze BOOKING_URL unten mit deinem echten Buchungslink (z. B. Calendly, cal.com, Terminland, Shore, etc.)
// - Admin-Login ist clientseitig (Demo). Für echte Sicherheit bitte serverseitige Auth verwenden.

const BOOKING_URL = "https://cal.com/dein-account/dein-event"; // oder Calendly-URL

// Services (eingebettet). name, preis, dauer (Minuten)
const SERVICES = [
  { id: 1, name: "Maschinenhaarschnitt (Herren)", preis: "11 €", dauer: 20 },
  { id: 2, name: "Trockenschnitt (Herren)", preis: "15 €", dauer: 25 },
  { id: 3, name: "Waschen, Schneiden (Herren)", preis: "17 €", dauer: 30 },
  { id: 4, name: "Waschen, Schneiden, Föhnen (Herren)", preis: "19,50 €", dauer: 35 },
  { id: 5, name: "Trockenschnitt (Damen)", preis: "19 €", dauer: 30 },
  { id: 6, name: "Waschen, Schneiden (Damen)", preis: "21 €", dauer: 35 },
  { id: 7, name: "Waschen, Schneiden, Föhnen (kurz)", preis: "23 €", dauer: 45 },
  { id: 8, name: "Waschen, Schneiden, Föhnen (mittel)", preis: "28 €", dauer: 60 },
  { id: 9, name: "Waschen, Schneiden, Föhnen (lang)", preis: "33 €", dauer: 90 },
  { id: 10, name: "Ansatzfarbe", preis: "43 €", dauer: 90 },
  { id: 11, name: "Foliensträhnen XS (bis 15)", preis: "29 €", dauer: 60 },
  { id: 12, name: "Foliensträhnen S (halber Kopf)", preis: "49 €", dauer: 90 },
  { id: 13, name: "Foliensträhnen M (ganzer Kopf)", preis: "69 €", dauer: 120 },
  { id: 14, name: "Tönung", preis: "35 €", dauer: 60 },
  { id: 15, name: "Glossing", preis: "15 €", dauer: 20 },
  { id: 16, name: "Conditioner / Pflege", preis: "+5 €", dauer: 10 },
];

// Öffnungszeiten (0=So ... 6=Sa)
const OPENING = {
  4: { start: "11:30", end: "17:00" }, // Do
  5: { start: "11:30", end: "17:00" }, // Fr
  6: { start: "10:00", end: "14:00" }, // Sa
};

// ⚠️ Admin-Passwort auf globalThis, damit kein "Identifier already declared" bei HMR
if (typeof globalThis !== "undefined") {
  globalThis.__SALON_ADMIN_PW = "xxxx"; // vom Besitzer gesetzt
}

const fadeIn = {
  hidden: { opacity: 0, y: 12 },
  show: { opacity: 1, y: 0, transition: { duration: 0.5 } },
};

// Helpers
const pad = (n) => (n < 10 ? `0${n}` : `${n}`);
function parseTime(t) { const [h, m] = t.split(":").map(Number); return h*60+m; }
function fmtHM(min) { const h = Math.floor(min/60); const m = min%60; return `${pad(h)}:${pad(m)}`; }
function addDays(date, d) { const x = new Date(date); x.setDate(x.getDate()+d); return x; }
function toISODate(d) { return d.toISOString().slice(0,10); }
function toMinutes(hhmm){ const [h,m] = hhmm.split(":").map(Number); return h*60+m; }
function addMinutes(hhmm, mins){ const t = toMinutes(hhmm)+mins; const H = Math.floor(((t%1440)+1440)%1440/60); const M = ((t%60)+60)%60; const pad=(n)=>n.toString().padStart(2,'0'); return `${pad(H)}:${pad(M)}`; }
function overlap(startA, durA, startB, durB){ const a0=toMinutes(startA), a1=a0+durA; const b0=toMinutes(startB), b1=b0+durB; return a0 < b1 && b0 < a1; }
function serviceDur(id){ return SERVICES.find(s=>s.id===Number(id))?.dauer ?? 30; }
function getWeekStart(date=new Date()) { const d = new Date(date); const day = d.getDay(); // 0=So
  const diff = (day===0? -6 : 1-day); // Montag als Wochenstart
  return addDays(d, diff);
}
function firstOpenDateFrom(startDate){
  for(let i=0;i<14;i++){
    const d = addDays(startDate, i);
    if(OPENING[d.getDay()]) return d;
  }
  return startDate;
}
function slotsForDate(dateStr){
  const d = new Date(dateStr);
  const conf = OPENING[d.getDay()];
  if(!conf) return [];
  const start = parseTime(conf.start); const end = parseTime(conf.end);
  const out = []; for(let t=start; t<end; t+=30) out.push(fmtHM(t));
  return out;
}

export default function ProjektterminSeite() {
  const [email, setEmail] = React.useState("");
  const [adminOpen, setAdminOpen] = React.useState(false);
  const [adminTab, setAdminTab] = React.useState("kalender");
  const [adminAuthenticated, setAdminAuthenticated] = React.useState(false);
  const [adminPwInput, setAdminPwInput] = React.useState("");
  const [query, setQuery] = React.useState("");
  const [dateFilter, setDateFilter] = React.useState("");

  // Week calendar state
  const [weekStart, setWeekStart] = React.useState(getWeekStart());
  const [createOpen, setCreateOpen] = React.useState(false);
  const [createStep, setCreateStep] = React.useState("form"); // form | success
  const [draft, setDraft] = React.useState({ date: "", time: "", name: "", serviceId: SERVICES[0].id, stylist: "Kevin", duration: serviceDur(SERVICES[0].id) });

  const [appointments, setAppointments] = React.useState(() => {
    try {
      const raw = localStorage.getItem("salon_appts");
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr;
      }
    } catch(_){}
    return [
      { id: 1, date: "2025-10-25", time: "11:30", name: "Maya K.", serviceId: 1, stylist: "Kevin", status: "neu", duration: serviceDur(1) },
      { id: 2, date: "2025-10-25", time: "13:00", name: "Omar R.", serviceId: 10, stylist: "Lea", status: "bestätigt", duration: serviceDur(10) },
      { id: 3, date: "2025-10-26", time: "10:30", name: "Tina S.", serviceId: 12, stylist: "Kevin", status: "neu", duration: serviceDur(12) },
    ];
  });

  // Persistente Admin-Session (Demo)
  React.useEffect(() => {
    try {
      const ok = localStorage.getItem("salon_admin_ok") === "1";
      if (ok) setAdminAuthenticated(true);
    } catch (_) {}
  }, []);

  // 🔒 Termine persistent speichern
  React.useEffect(() => {
    try { localStorage.setItem("salon_appts", JSON.stringify(appointments)); } catch(_){}
  }, [appointments]);

  // DEV Self-Tests
  React.useEffect(()=>{
    // Test: Slot-Erzeugung Do 11:30–17:00 → mindestens 11 Slots in 30min Raster
    const slots = []; for(let t=parseTime("11:30"); t<parseTime("17:00"); t+=30) slots.push(fmtHM(t));
    if(slots.length < 11) console.error("Test fehlgeschlagen: Erwartet >=11 Slots, erhalten:", slots.length);
  },[]);

  // Calendar helpers
  const days = Array.from({length:7}, (_,i)=> addDays(weekStart, i));
  const isOpenAt = (d) => OPENING[d.getDay()];
  const apptsOn = (dateStr) => appointments.filter(a=>a.date===dateStr);
  const serviceById = (id) => SERVICES.find(s=>s.id===Number(id));

  // Create appointment helpers
  function openCreate(dateStr, timeStr){
    setDraft({ date: dateStr, time: timeStr || "", name: "", serviceId: SERVICES[0].id, stylist: "Kevin" });
    setCreateStep("form");
    setCreateOpen(true);
  }
  function defaultDateTimeForNew(){
    // Nimmt erste geöffnete Tages/Slot-Kombi ab heute
    const start = firstOpenDateFrom(new Date());
    const dateStr = toISODate(start);
    const allSlots = slotsForDate(dateStr);
    // freie Slots filtern
    const taken = new Set(apptsOn(dateStr).map(a=>a.time));
    const free = allSlots.filter(s=>!taken.has(s));
    return { date: dateStr, time: free[0] || "" };
  }
  function saveDraft(){
    const conflict = appointments.some(a=>a.date===draft.date && a.time===draft.time);
    if(conflict) { alert("Dieser Slot ist bereits belegt."); return; }
    if(!draft.name || !draft.date || !draft.time) { alert("Bitte Name, Datum und Uhrzeit angeben."); return; }
    const id = Math.max(0, ...appointments.map(a=>a.id)) + 1;
    const newAppt = { id, date: draft.date, time: draft.time, name: draft.name.trim(), serviceId: Number(draft.serviceId), stylist: draft.stylist||"Kevin", status: "neu" };
    setAppointments([newAppt, ...appointments]);
    setCreateStep("success");
  }

  // Week navigation
  function shiftWeek(delta){ setWeekStart(addDays(weekStart, delta*7)); }

  // Daten für „Neuer Termin“-Dialog (Termine-Tab)
  const newDefaults = React.useMemo(()=> defaultDateTimeForNew(), [appointments]);

  return (
    <div className="min-h-screen bg-[radial-gradient(1200px_600px_at_50%_-200px,rgba(56,189,248,0.15),transparent)] from-white to-slate-50 text-slate-900">
      {/* Header */}
      <header className="sticky top-0 z-50 bg-white/60 supports-[backdrop-filter]:backdrop-blur border-b border-white/40">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="size-9 rounded-2xl bg-slate-900 text-white grid place-items-center"><Scissors className="size-5" /></div>
            <span className="font-semibold">Salontermin</span>
            <span className="ml-2 inline-flex items-center gap-1 rounded-full bg-emerald-50 text-emerald-700 px-2 py-1 text-xs border border-emerald-200">★ 4.96</span>
          </div>
          <div className="flex items-center gap-2">
            <a href="#faq" className="text-sm hover:underline">FAQ</a>
            <a href="#kontakt" className="text-sm hover:underline">Kontakt</a>
            <Button variant="outline" className="rounded-2xl" onClick={() => setAdminOpen(true)}><Settings className="mr-2 size-4" /> Admin</Button>
            <Dialog>
              <DialogTrigger asChild>
                <Button data-book className="bg-sky-600 text-white hover:bg-sky-700 rounded-2xl">Termin buchen</Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-2xl">
                <DialogHeader>
                  <DialogTitle>Termin buchen</DialogTitle>
                  <DialogDescription>
                    Wähle einen passenden Slot. Die Buchung ist kostenlos und unverbindlich.
                  </DialogDescription>
                </DialogHeader>
                {/* 👉 Variante 1: Weiterleitung per Button */}
                <div className="flex flex-col gap-3">
                  <a
                    href={BOOKING_URL}
                    target="_blank"
                    rel="noreferrer noopener"
                    className="inline-flex items-center justify-center rounded-2xl border px-4 py-3 hover:bg-slate-50"
                    aria-label="Zur externen Buchungsseite (öffnet in neuem Tab)"
                  >
                    Zur Buchungsseite (neuer Tab)
                    <ChevronRight className="ml-2 size-4" />
                  </a>

                  {/* 👉 Variante 2: Direktes Embed (IFRAME) */}
                  <div className="aspect-[4/3] w-full overflow-hidden rounded-2xl border">
                    <iframe
                      title="Buchungskalender"
                      src={`${BOOKING_URL}?embed=1`}
                      className="w-full h-full"
                    />
                  </div>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </div>
      </header>

      {/* Hero */}
      <section className="max-w-6xl mx-auto px-4 pt-16 pb-14 grid md:grid-cols-2 gap-10 items-center">
        <motion.div initial="hidden" animate="show" variants={fadeIn}>
          <h1 className="text-3xl md:text-5xl font-extrabold leading-tight">
            Friseurtermin buchen – schnell, einfach, flexibel
          </h1>
          <p className="mt-4 text-slate-600 max-w-prose">
            Schnitt, Farbe oder Styling genau so, wie du es magst. Wähle deinen Service und buche deinen Slot in 30–60 Minuten – ganz bequem online.
          </p>
          <div className="mt-3 rounded-xl border bg-amber-50 text-amber-900 p-3 text-sm">
            <strong>Hinweis:</strong> Bis einschließlich <strong>24.10.2025</strong> ausgebucht. Nächste freie Termine ab <strong>25.10.2025</strong>.
          </div>
          <div className="mt-6 flex flex-wrap gap-3">
            <Dialog>
              <DialogTrigger asChild>
                <Button data-book className="bg-sky-600 text-white hover:bg-sky-700 h-11 rounded-2xl">
                  <Calendar className="mr-2 size-4" /> Jetzt Friseurtermin sichern
                </Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-2xl">
                <DialogHeader>
                  <DialogTitle>Termin auswählen</DialogTitle>
                  <DialogDescription>
                    Du wirst zur sicheren Buchungsseite weitergeleitet.
                  </DialogDescription>
                </DialogHeader>
                <a
                  href={BOOKING_URL}
                  target="_blank"
                  rel="noreferrer noopener"
                  className="inline-flex items-center justify-center rounded-2xl border px-4 py-3 hover:bg-slate-50"
                >
                  Öffnen & Termin wählen
                  <ChevronRight className="ml-2 size-4" />
                </a>
              </DialogContent>
            </Dialog>
            <a href="#ablauf" className="inline-flex items-center text-sm underline">
              So läuft's ab
              <ChevronRight className="ml-1 size-4" />
            </a>
          </div>
          <div className="mt-6 flex items-center gap-4 text-sm text-slate-600">
            <div className="inline-flex items-center gap-2">
              <Clock className="size-4" /> 30–60 Min
            </div>
            <div className="inline-flex items-center gap-2">
              <ShieldCheck className="size-4" /> DSGVO-konform
            </div>
          </div>
        </motion.div>

        <motion.div initial="hidden" animate="show" variants={fadeIn} className="md:justify-self-end">
          <Card className="rounded-2xl shadow-lg border-white/60 bg-white/70 supports-[backdrop-filter]:backdrop-blur">
            <CardHeader>
              <CardTitle>Beliebte Services</CardTitle>
              <CardDescription>Auswahl bei der Buchung – Preise und Dauer je nach Haarlänge.</CardDescription>
            </CardHeader>
            <CardContent className="grid gap-3">
              {["Maschinenhaarschnitt (Herren)", "Waschen, Schneiden, Föhnen (kurz)", "Ansatzfarbe"].map((title, i) => (
                <div key={i} className="rounded-xl border p-4">
                  <div className="font-semibold">{title}</div>
                  <div className="text-sm text-slate-600">Preis & Dauer siehst du bei der Auswahl.</div>
                </div>
              ))}
            </CardContent>
          </Card>
        </motion.div>
      </section>

      {/* Ablauf */}
      <section id="ablauf" className="max-w-6xl mx-auto px-4 py-10">
        <h2 className="text-2xl md:text-3xl font-bold">So buchst du deinen Friseurtermin</h2>
        <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          {[{step:"1",title:"Termin wählen",text:"Klicke auf „Termin buchen“ und wähle einen Slot, der für dich passt."},{step:"2",title:"Stylist auswählen",text:"Lieblings-Stylist:in auswählen – je nach Verfügbarkeit."},{step:"3",title:"Bestätigung & Erinnerung",text:"Du erhältst E‑Mail-Bestätigung und Termin‑Erinnerung."}].map((s) => (
            <Card key={s.step} className="rounded-2xl">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <span className="inline-flex size-7 items-center justify-center rounded-full border text-sm font-semibold">{s.step}</span>
                  {s.title}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-slate-600">{s.text}</p>
              </CardContent>
            </Card>
          ))}
        </div>
      </section>

      {/* Standort & Öffnungszeiten */}
      <section id="standort" className="max-w-6xl mx-auto px-4 py-10">
        <h2 className="text-2xl md:text-3xl font-bold">Standort & Öffnungszeiten</h2>
        <div className="mt-6 grid md:grid-cols-2 gap-4">
          <Card className="rounded-2xl">
            <CardHeader>
              <CardTitle>Unser Salon</CardTitle>
              <CardDescription>Gut erreichbar, zentrale Lage</CardDescription>
            </CardHeader>
            <CardContent className="text-sm text-slate-600 grid gap-2">
              <div className="inline-flex items-center gap-2">
                <MapPin className="size-4" /> Rather Kreuzweg 62, 40472 Düsseldorf
              </div>
              <a href="https://www.google.com/maps?q=Rather+Kreuzweg+62,+40472+D%C3%BCsseldorf" target="_blank" rel="noreferrer noopener" className="underline">
                Route in Google Maps öffnen
              </a>
            </CardContent>
          </Card>

          <Card className="rounded-2xl">
            <CardHeader>
              <CardTitle>Öffnungszeiten</CardTitle>
              <CardDescription>Aktuelle Sprech- und Servicezeiten</CardDescription>
            </CardHeader>
            <CardContent className="text-sm text-slate-600 grid gap-1">
              <div>Mo–Mi: geschlossen</div>
              <div>Do: 11:30–17:00</div>
              <div>Fr: 11:30–17:00</div>
              <div>Sa: 10:00–14:00</div>
              <div>So/Feiertag: geschlossen</div>
            </CardContent>
          </Card>
        </div>
      </section>

      {/* Bewertungen */}
      <section id="bewertungen" className="max-w-6xl mx-auto px-4 py-10">
        <h2 className="text-2xl md:text-3xl font-bold">Bewertungen</h2>
        <div className="mt-2 inline-flex items-center gap-2 text-slate-700">
          <span className="font-semibold">4.96/5</span>
          <div aria-label="4.96 von 5 Sternen" className="text-amber-500">★★★★★</div>
          <span className="text-xs text-slate-500">(aus jüngsten Google-Bewertungen)</span>
        </div>
      </section>

      {/* Kontakt */}
      <section id="kontakt" className="max-w-6xl mx-auto px-4 py-10">
        <h2 className="text-2xl md:text-3xl font-bold">Kontakt</h2>
        <div className="mt-6 grid md:grid-cols-2 gap-4">
          <Card className="rounded-2xl">
            <CardHeader>
              <CardTitle>Direkter Draht</CardTitle>
              <CardDescription>Wir melden uns innerhalb eines Werktags.</CardDescription>
            </CardHeader>
            <CardContent className="grid gap-2 text-sm">
              <a href="tel:+491783749554" className="inline-flex items-center gap-2 hover:underline">
                <Phone className="size-4" /> 0178 3749554
              </a>
              <a href="mailto:hallo@beispiel.de" className="inline-flex items-center gap-2 hover:underline">
                <Mail className="size-4" /> hallo@beispiel.de
              </a>
            </CardContent>
          </Card>

          <AdminPanel />
        </div>
      </section>

      {/* Floating CTA (mobil) */}
      <div className="fixed bottom-4 right-4 z-50 md:hidden flex flex-col gap-2">
        <a href={BOOKING_URL} target="_blank" rel="noreferrer noopener" className="rounded-full shadow-lg bg-sky-600 text-white px-5 py-3 text-sm">Jetzt buchen</a>
        <a href="tel:+491783749554" className="rounded-full shadow-lg bg-white border px-5 py-3 text-sm">Anrufen</a>
      </div>

      {/* Footer */}
      <footer className="border-t">
        <div className="max-w-6xl mx-auto px-4 py-8 text-sm text-slate-500 flex flex-col md:flex-row items-center justify-between gap-3">
          <div>© {new Date().getFullYear()} Salontermin. Alle Rechte vorbehalten.</div>
          <div className="flex items-center gap-4">
            <a href="#" className="hover:underline">Impressum</a>
            <a href="#" className="hover:underline">Datenschutz</a>
          </div>
        </div>
      </footer>

      {/* Admin Modal Trigger */}
      <AdminDialog
        open={adminOpen}
        onOpenChange={setAdminOpen}
        adminAuthenticated={adminAuthenticated}
        setAdminAuthenticated={setAdminAuthenticated}
        adminPwInput={adminPwInput}
        setAdminPwInput={setAdminPwInput}
        adminTab={adminTab}
        setAdminTab={setAdminTab}
        weekStart={weekStart}
        setWeekStart={setWeekStart}
        days={days}
        isOpenAt={isOpenAt}
        apptsOn={apptsOn}
        serviceById={serviceById}
        appointments={appointments}
        setAppointments={setAppointments}
        openCreate={openCreate}
        createOpen={createOpen}
        setCreateOpen={setCreateOpen}
        createStep={createStep}
        setCreateStep={setCreateStep}
        draft={draft}
        setDraft={setDraft}
        defaultDateTimeForNew={defaultDateTimeForNew}
      />
    </div>
  );
}

function AdminDialog(props){
  const { open, onOpenChange, adminAuthenticated, setAdminAuthenticated, adminPwInput, setAdminPwInput, adminTab, setAdminTab, weekStart, setWeekStart, days, isOpenAt, apptsOn, serviceById, appointments, setAppointments, openCreate, createOpen, setCreateOpen, createStep, setCreateStep, draft, setDraft, defaultDateTimeForNew } = props;

  function shiftWeek(delta){ setWeekStart(addDays(weekStart, delta*7)); }

  // Für „Neuer Termin“ Dialog im Termine-Tab
  const [listCreateOpen, setListCreateOpen] = React.useState(false);

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[1100px] max-h-[85vh] overflow-auto">
        {!adminAuthenticated ? (
          <>
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2"><Settings className="size-4"/> Admin-Login</DialogTitle>
              <DialogDescription>Bitte Passwort eingeben, um das Dashboard zu öffnen.</DialogDescription>
            </DialogHeader>
            <form onSubmit={(e)=>{e.preventDefault(); const ok = (window.__SALON_ADMIN_PW ?? "SALON-ADMIN-1234") === adminPwInput; if(ok){ setAdminAuthenticated(true); try{ localStorage.setItem('salon_admin_ok','1'); }catch(_){} } else { alert('Falsches Passwort'); }}} className="grid gap-3">
              <div>
                <Label htmlFor="adminpw">Passwort</Label>
                <Input id="adminpw" type="password" className="rounded-2xl" value={adminPwInput} onChange={(e)=>setAdminPwInput(e.target.value)} placeholder="••••••••" required />
              </div>
              <div className="flex gap-2">
                <Button type="submit" className="rounded-2xl">Einloggen</Button>
                <Button type="button" variant="outline" className="rounded-2xl" onClick={()=>onOpenChange(false)}>Abbrechen</Button>
              </div>
              <div className="text-xs text-slate-500">Hinweis: Clientseitiger Demo-Schutz – für echte Sicherheit bitte serverseitige Auth verwenden.</div>
            </form>
          </>
        ) : (
          <>
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2"><Settings className="size-4"/> Admin-Dashboard</DialogTitle>
              <DialogDescription>Wochenkalender, Termine, Services & Einstellungen.</DialogDescription>
            </DialogHeader>

            {/* Tabs */}
            <div className="flex items-center gap-2 text-sm">
              {["kalender","termine","services","einstellungen"].map((key)=> (
                <button key={key} onClick={()=>setAdminTab(key)} className={`px-3 py-2 rounded-xl border ${adminTab===key? 'bg-slate-900 text-white' : 'bg-white hover:bg-slate-50'}`}>{key[0].toUpperCase()+key.slice(1)}</button>
              ))}
              <div className="ml-auto">
                <Button variant="outline" className="rounded-2xl" onClick={()=>{ setAdminAuthenticated(false); try{ localStorage.removeItem('salon_admin_ok'); }catch(_){} setAdminPwInput(''); }}>Logout</Button>
              </div>
            </div>

            {/* Kalender Tab */}
            {adminTab === 'kalender' && (
              <div className="mt-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm text-slate-600">Woche ab <strong>{toISODate(weekStart)}</strong></div>
                  <div className="flex gap-2">
                    <Button variant="outline" className="rounded-2xl" onClick={()=>shiftWeek(-1)}>Vorherige Woche</Button>
                    <Button className="rounded-2xl" onClick={()=>setWeekStart(getWeekStart(new Date()))}>Heute</Button>
                    <Button variant="outline" className="rounded-2xl" onClick={()=>shiftWeek(1)}>Nächste Woche</Button>
                  </div>
                </div>

                <div className="overflow-auto rounded-2xl border max-h-[70vh]">
                  <div className="min-w-[900px]">
                    {/* Header row */}
                    <div className="grid" style={{gridTemplateColumns:`100px repeat(7, 1fr)`}}>
                      <div className="bg-slate-50 border-b p-2 text-xs text-slate-500 sticky top-0 z-20">Zeit</div>
                      {days.map((d,i)=> (
                        <div key={i} className="bg-slate-50 border-b p-2 text-xs text-slate-600 sticky top-0 z-10">
                          {d.toLocaleDateString('de-DE', { weekday:'short', day:'2-digit', month:'2-digit'})}
                          {isOpenAt(d) ? null : <span className="ml-2 text-[10px] text-slate-400">geschlossen</span>}
                        </div>
                      ))}
                    </div>
                    {/* Time rows */}
                    {Array.from({length: 48}, (_,r)=> r*30).map((tMin, ri)=> (
                      <div key={ri} className="grid" style={{gridTemplateColumns:`100px repeat(7, 1fr)`}}>
                        <div className="border-t p-2 text-[11px] text-slate-500 sticky left-0 bg-white z-10">{fmtHM(tMin)}</div>
                        {days.map((d,ci)=> {
                          const conf = isOpenAt(d);
                          const tStr = fmtHM(tMin);
                          const open = !!conf && parseTime(tStr) >= parseTime(conf.start) && parseTime(tStr) < parseTime(conf.end);
                          const dateStr = toISODate(d);
                          const items = apptsOn(dateStr).filter(a=>a.time===tStr);
                          return (
                            <div key={ci} className={`border-t border-l p-1 min-h-[28px] ${open? 'bg-white' : 'bg-slate-50/60'}`}>
                              {items.map(a=>{
                                const s = serviceById(a.serviceId);
                                return (
                                  <div key={a.id} className="text-[11px] rounded-lg border px-2 py-1 mb-1 bg-emerald-50 border-emerald-200">
                                    <div className="font-medium truncate">{a.name} • {s? s.name : 'Service'} ({a.stylist})</div>
                                    <div className="text-slate-700">{tStr} – {addMinutes(tStr, a.duration || (s? s.dauer:0))} • {a.status}</div>
                                  </div>
                                );
                              })}
                              {items.length===0 && (
                                <button className="w-full h-full text-[11px] text-slate-400 hover:text-slate-700" onClick={()=>openCreate(dateStr, tStr)}>
                                  <Plus className="inline size-3 mr-1"/> Termin
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Create dialog from calendar */}
                <CreateAppointmentDialog
                  open={createOpen}
                  onOpenChange={(v)=>{ setCreateOpen(v); if(!v) setCreateStep('form'); }}
                  step={createStep}
                  setStep={setCreateStep}
                  draft={draft}
                  setDraft={setDraft}
                  appointments={appointments}
                  onSave={(appt)=> setAppointments([appt, ...appointments])}
                  allowAnyTime={true}
                />
              </div>
            )}

            {/* Services Tab */}
            {adminTab === 'services' && (
              <div className="mt-4 grid gap-3 text-sm">
                <div className="text-slate-600">Dienstleistungen (aus Datei geladen):</div>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {SERVICES.map((s)=> (
                    <Card key={s.id} className="rounded-2xl">
                      <CardHeader>
                        <CardTitle className="text-base">{s.name}</CardTitle>
                        <CardDescription>{s.preis} • {s.dauer} Min</CardDescription>
                      </CardHeader>
                      <CardContent className="flex gap-2">
                        <Button size="sm" className="rounded-xl"><Edit className="size-4 mr-1"/> Bearbeiten</Button>
                        <Button size="sm" variant="outline" className="rounded-xl"><Trash2 className="size-4 mr-1"/> Entfernen</Button>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              </div>
            )}

            {/* Einstellungen Tab */}
            {adminTab === 'einstellungen' && (
              <div className="mt-4 grid gap-4">
                <Card className="rounded-2xl">
                  <CardHeader>
                    <CardTitle>Öffnungszeiten</CardTitle>
                  </CardHeader>
                  <CardContent className="grid md:grid-cols-3 gap-2 text-sm">
                    <div>Do: 11:30–17:00</div>
                    <div>Fr: 11:30–17:00</div>
                    <div>Sa: 10:00–14:00</div>
                  </CardContent>
                </Card>
                <Card className="rounded-2xl">
                  <CardHeader>
                    <CardTitle>Abwesenheiten/Schließtage</CardTitle>
                  </CardHeader>
                  <CardContent className="grid gap-2 text-sm">
                    <div>Bis 24.10.2025: ausgebucht</div>
                    <div>Ab 25.10.2025: Termine verfügbar</div>
                  </CardContent>
                </Card>
              </div>
            )}
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}

function CreateAppointmentDialog({ open, onOpenChange, step, setStep, draft, setDraft, appointments, onSave, allowAnyTime = false }){
  const [stepMins, setStepMins] = React.useState(10); // 5/10/15/30
  const [useEndTime, setUseEndTime] = React.useState(false);

  function isOpen(dateStr){ const d=new Date(dateStr); return !!OPENING[d.getDay()]; }
  function freeTimesAllDay(dateStr){
    if(!dateStr) return [];
    const out=[]; for(let t=0; t<24*60; t+=stepMins) out.push(fmtHM(t));
    const taken = new Set(appointments.filter(a=>a.date===dateStr).map(a=>a.time));
    return out.filter(t=>!taken.has(t));
  }
  function freeTimesOpening(dateStr){
    if(!dateStr) return [];
    const conf = OPENING[new Date(dateStr).getDay()];
    if(!conf) return [];
    const out=[]; for(let t=parseTime(conf.start); t<parseTime(conf.end); t+=stepMins) out.push(fmtHM(t));
    const taken = new Set(appointments.filter(a=>a.date===dateStr).map(a=>a.time));
    return out.filter(t=>!taken.has(t));
  }
  const options = (allowAnyTime? freeTimesAllDay : freeTimesOpening)(draft.date);

  const hasOverlap = draft.date && draft.time && appointments.some(a=> a.date===draft.date && overlap(draft.time, Number(draft.duration||0)||serviceDur(draft.serviceId), a.time, a.duration || serviceDur(a.serviceId)) );

  function handleSave(){
    if(!draft.name || !draft.date || !draft.time){ alert("Bitte Name, Datum und Uhrzeit angeben."); return; }
    const dur = Number(draft.duration)||serviceDur(draft.serviceId);
    if(dur <= 0){ alert("Bitte eine gültige Dauer angeben."); return; }
    if(hasOverlap){ alert("Konflikt: Überschneidung mit bestehendem Termin."); return; }
    const id = Math.floor(Math.random()*1e6);
    const appt = { id, date: draft.date, time: draft.time, name: draft.name.trim(), serviceId: Number(draft.serviceId), stylist: draft.stylist||"Kevin", status: "neu", duration: dur };
    onSave(appt);
    setStep("success");
  }
  function resetAndClose(){ setStep("form"); onOpenChange(false); }
  const endTime = draft.time && (Number(draft.duration)||serviceDur(draft.serviceId)) ? addMinutes(draft.time, Number(draft.duration)||serviceDur(draft.serviceId)) : "";

  return (
    <Dialog open={open} onOpenChange={resetAndClose}>
      <DialogContent className="sm:max-w-md">
        {step === 'form' ? (
          <>
            <DialogHeader>
              <DialogTitle>Termin anlegen</DialogTitle>
              <DialogDescription>Startzeit auswählen (oder tippen), dann Dauer oder Endzeit.</DialogDescription>
            </DialogHeader>
            <div className="grid gap-3">
              <div>
                <Label htmlFor="name">Kund:in</Label>
                <Input id="name" value={draft.name} onChange={(e)=>setDraft({...draft, name:e.target.value})} className="rounded-2xl" placeholder="Name" />
              </div>
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <Label htmlFor="date">Datum</Label>
                  <Input id="date" type="date" className="rounded-2xl" value={draft.date} onChange={(e)=> setDraft({...draft, date: e.target.value, time: ''})} />
                </div>
                <div>
                  <Label>Zeit-Raster</Label>
                  <Select value={String(stepMins)} onValueChange={(v)=> setStepMins(Number(v))}>
                    <SelectTrigger className="rounded-2xl"><SelectValue /></SelectTrigger>
                    <SelectContent>
                      {[5,10,15,30].map(v=> <SelectItem key={v} value={String(v)}>{v} Minuten</SelectItem>)}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <Label>Startzeit</Label>
                  <div className="flex gap-2">
                    <Select value={draft.time} onValueChange={(v)=> setDraft({...draft, time:v})}>
                      <SelectTrigger className="rounded-2xl"><SelectValue placeholder={draft.date? (options.length? 'Uhrzeit wählen' : 'Keine freien Zeiten') : 'Erst Datum wählen'} /></SelectTrigger>
                      <SelectContent>
                        {options.map(t=> <SelectItem key={t} value={t}>{t}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Input type="time" step={stepMins*60} value={draft.time} onChange={(e)=> setDraft({...draft, time:e.target.value})} className="rounded-2xl" />
                  </div>
                </div>
                <div>
                  <Label>Endzeit statt Dauer?</Label>
                  <div className="flex items-center gap-2 text-sm">
                    <input id="useEnd" type="checkbox" checked={useEndTime} onChange={(e)=> setUseEndTime(e.target.checked)} />
                    <label htmlFor="useEnd">Ich gebe eine Endzeit ein</label>
                  </div>
                </div>
              </div>

              {!useEndTime ? (
                <div>
                  <Label htmlFor="duration">Dauer (Minuten)</Label>
                  <Input id="duration" type="number" min={5} step={5} value={draft.duration ?? ''} onChange={(e)=> setDraft({...draft, duration: Number(e.target.value)||0})} className="rounded-2xl" placeholder="z. B. 35" />
                  {draft.time && (draft.duration>0) && <div className="text-xs text-slate-500 mt-1">Ende: <strong>{endTime}</strong></div>}
                </div>
              ) : (
                <div>
                  <Label htmlFor="end">Endzeit</Label>
                  <Input id="end" type="time" step={stepMins*60} value={endTime} onChange={(e)=> {
                    if(!draft.time) return;
                    const d = toMinutes(e.target.value) - toMinutes(draft.time);
                    setDraft({...draft, duration: Math.max(5, d)});
                  }} className="rounded-2xl" />
                </div>
              )}

              <div>
                <Label htmlFor="service">Dienstleistung</Label>
                <Select value={String(draft.serviceId)} onValueChange={(v)=> setDraft({...draft, serviceId: Number(v), duration: serviceDur(v)})}>
                  <SelectTrigger className="rounded-2xl"><SelectValue placeholder="Service wählen" /></SelectTrigger>
                  <SelectContent>
                    {SERVICES.map(s=> (
                      <SelectItem key={s.id} value={String(s.id)}>{s.name} – {s.preis} • {s.dauer} Min</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="stylist">Stylist:in</Label>
                <Input id="stylist" value={draft.stylist} onChange={(e)=>setDraft({...draft, stylist:e.target.value})} className="rounded-2xl" placeholder="z. B. Kevin" />
              </div>
              {hasOverlap && <div className="text-sm text-rose-600">Achtung: Überschneidung mit bestehendem Termin.</div>}
              <div className="flex gap-2 pt-1">
                <Button className="rounded-2xl" onClick={handleSave} disabled={!draft.name || !draft.date || !draft.time}>Speichern</Button>
                <Button variant="outline" className="rounded-2xl" onClick={resetAndClose}>Abbrechen</Button>
              </div>
            </div>
          </>
        ) : (
          <>
            <DialogHeader>
              <DialogTitle>Termin gebucht</DialogTitle>
              <DialogDescription>Der Termin wurde gespeichert und erscheint im Kalender.</DialogDescription>
            </DialogHeader>
            <div className="rounded-xl border p-4 text-sm bg-emerald-50 text-emerald-900">
              <div><strong>{draft.name}</strong> – {SERVICES.find(s=>s.id===Number(draft.serviceId))?.name}</div>
              <div>{draft.date} • {draft.time} – {endTime} • Stylist: {draft.stylist}</div>
            </div>
            <div className="flex gap-2 pt-3">
              <Button className="rounded-2xl" onClick={resetAndClose}>OK</Button>
            </div>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}

// AdminPanel in Kontakt-Spalte: Kurzinfo + Admin öffnen
function AdminPanel(){
  return (
    <Card className="rounded-2xl">
      <CardHeader>
        <CardTitle>Für Inhaber:in</CardTitle>
        <CardDescription>Kalender & Termine verwalten</CardDescription>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-slate-600 mb-3">Öffne oben im Header den <strong>Admin</strong>-Bereich: Wochenkalender, Terminliste, Services & Einstellungen.</p>
        <ul className="text-sm list-disc pl-5 text-slate-600">
          <li>Wöchentliche Kalenderansicht</li>
          <li>Termin anlegen, bestätigen, absagen</li>
          <li>Dienstleistungen verwalten</li>
        </ul>
      </CardContent>
    </Card>
  );
}
